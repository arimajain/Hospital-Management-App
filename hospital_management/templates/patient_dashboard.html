{% extends "base.html" %}

{% block content %}
<style>
    /* Simple Card */
    .card { border: 1px solid #e9ecef; border-radius: 12px; box-shadow: none; }

    /* Date Box */
    .date-badge {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;
        width: 60px; height: 60px; flex-shrink: 0; margin-right: 1rem; color: #212529;
    }
    .date-badge .month { font-size: 0.7rem; text-transform: uppercase; font-weight: bold; color: #6c757d; }
    .date-badge .day { font-size: 1.2rem; font-weight: 700; line-height: 1; }
    
    /* Dropdown Style */
    .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 300px;
        overflow-y: auto;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="fw-bold mb-1">Hello, {{ session.get('full_name').split()[0] }}</h2>
    <div class="text-muted">Patient ID: <span class="fw-bold text-dark">P{{ "%02d" | format(patient.id) }}</span></div>
  </div>
  <div><a class="btn btn-outline-secondary" href="{{ url_for('patient_profile') }}">Edit Profile</a></div>
</div>

<div class="mb-5 position-relative">
    <form action="{{ url_for('patient_dashboard') }}" method="get" class="mb-3">
        <label class="form-label fw-bold">Find a Doctor</label>
        <div class="input-group input-group-lg">
            <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Search by name or department..." autocomplete="off">
            <button class="btn btn-primary px-4" type="submit">Search</button>
        </div>
    </form>

    {% if q %}
      <div class="search-dropdown list-group">
          <div class="list-group-item bg-light d-flex justify-content-between align-items-center">
              <small class="fw-bold text-muted">Search Results</small>
              <a href="{{ url_for('patient_dashboard') }}" class="btn-close btn-sm"></a>
          </div>
          {% if search_results %}
             {% for d in search_results %}
               <a href="{{ url_for('patient_view_doctor_profile', doctor_id=d.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                 <div><span class="fw-bold text-dark">{{ d.full_name }}</span> <span class="text-muted small ms-2">({{ d.department or 'General' }})</span></div>
                 <small class="text-primary">View</small>
               </a>
             {% endfor %}
          {% else %}
             <div class="list-group-item text-center text-muted py-3">No matching doctors found.</div>
          {% endif %}
      </div>
    {% endif %}

    <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="text-muted small fw-bold text-uppercase me-2">Browse by Specialization:</span>
        {% for dept in departments %}
            <a href="{{ url_for('patient_dashboard', q=dept.name) }}" class="btn btn-sm btn-outline-secondary rounded-pill">{{ dept.name }}</a>
        {% endfor %}
    </div>
</div>


<section class="mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold mb-0">Available Doctors</h5>
      <a href="{{ url_for('patient_all_doctors') }}" class="text-decoration-none small">View all &rarr;</a>
  </div>
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">
    {% if doctors %}
      {% for doc in doctors %}
        <div class="col">
          <div class="card h-100 p-3">
            <div class="d-flex align-items-center mb-3">
                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width:48px; height:48px; font-weight:bold;">{{ doc.full_name[:1] }}</div>
                <div><h6 class="mb-0 fw-bold">{{ doc.full_name }}</h6><small class="text-primary">{{ doc.department or 'General' }}</small></div>
            </div>
            <div class="d-flex gap-2 mt-auto">
                <a class="btn btn-outline-secondary btn-sm flex-fill" href="{{ url_for('patient_view_doctor_profile', doctor_id=doc.id) }}">Profile</a>
                <a class="btn btn-dark btn-sm flex-fill" href="{{ url_for('patient_view_doctor_availability', doctor_id=doc.id) }}">Slots</a>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-12 text-muted">No doctors available.</div>
    {% endif %}
  </div>
</section>

<section class="mb-5">
  <h5 class="fw-bold mb-3">Upcoming Appointments</h5>
  <div class="row g-3">
    {% if upcoming %}
      {% for a in upcoming %}
        <div class="col-md-6">
          <div class="card p-3 h-100">
            <div class="d-flex align-items-center mb-3">
              <div class="date-badge"><span class="month">DATE</span><span class="day">{{ a.date.split('-')[2] }}</span></div>
              <div>
                <h5 class="mb-1 fw-bold">{{ a.doctor_name }}</h5>
                <div class="small text-muted">{{ a.time }}</div>
                <span class="badge bg-primary bg-opacity-10 text-primary mt-1">{{ a.status }}</span>
              </div>
            </div>
            <div class="d-flex gap-2 mt-auto">
                <a class="btn btn-sm btn-outline-primary flex-fill" href="{{ url_for('patient_request_reschedule', appointment_id=a.id) }}">Reschedule</a>
                <form method="post" action="{{ url_for('patient_cancel_appointment', appointment_id=a.id) }}" class="flex-fill" onsubmit="return confirm('Cancel?');">
                    <button class="btn btn-sm btn-outline-danger w-100">Cancel</button>
                </form>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-12"><div class="p-4 text-center text-muted border rounded bg-white">No upcoming appointments.</div></div>
    {% endif %}
  </div>
</section>

<section>
  <h5 class="fw-bold mb-3">History</h5>
  <div class="card">
      <div class="list-group list-group-flush">
        {% if past %}
          {% for a in past %}
            <div class="list-group-item p-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div><h6 class="mb-0 fw-bold">{{ a.doctor_name }}</h6><small class="text-muted">{{ a.date }} â€¢ {{ a.time }}</small></div>
                <span class="badge bg-secondary bg-opacity-25 text-dark">{{ a.status }}</span>
              </div>
              {% if a.diagnosis or a.prescription or a.notes %}
                <div class="bg-light p-2 rounded small text-muted mt-2">
                    {% if a.diagnosis %}<div><strong>Diagnosis:</strong> {{ a.diagnosis }}</div>{% endif %}
                    {% if a.prescription %}<div><strong>Prescription:</strong> {{ a.prescription }}</div>{% endif %}
                    {% if a.notes %}<div><strong>Notes:</strong> {{ a.notes }}</div>{% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <div class="p-4 text-center text-muted">No history found.</div>
        {% endif %}
      </div>
  </div>
</section>
{% endblock %}