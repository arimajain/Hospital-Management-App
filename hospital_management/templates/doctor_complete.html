{% extends "base.html" %}
{% block content %}


<div class="card mb-3 p-3">
  <p><strong>Patient:</strong> {{ appt.patient_name }}</p>
  <p><strong>Date:</strong> {{ appt.date }} &nbsp; <strong>Time:</strong> {{ appt.time }} - {{ appt.end_time }}</p>
  <p><strong>Status:</strong> {{ appt.status }}</p>
</div>

{% if appt.status in ['Booked','Completed'] %}
  <div class="card mb-3 p-3">
    <h5>Complete visit & add treatment</h5>
    <form method="post" action="{{ url_for('doctor_complete_appointment', appointment_id=appt.id) }}">
      <div class="mb-2">
        <label class="form-label">Diagnosis</label>
        <textarea name="diagnosis" class="form-control" rows="2">{{ treatment.diagnosis if treatment else '' }}</textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Prescription</label>
        <textarea name="prescription" class="form-control" rows="2">{{ treatment.prescription if treatment else '' }}</textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Notes</label>
        <textarea name="notes" class="form-control" rows="2">{{ treatment.notes if treatment else '' }}</textarea>
      </div>
      {% if appt.status == 'Booked' %}
        <button class="btn btn-success">Mark Completed & Save</button>
      {% else %}
        <button class="btn btn-success">Save Treatment</button>
      {% endif %}
    </form>
  </div>

  <!-- Cancel button removed from edit screen per request (use dashboard to cancel) -->
{% else %}
  <div class="alert alert-info">No actions allowed for this appointment (status: {{ appt.status }}).</div>
{% endif %}

<h4>Patient treatment history</h4>
{% if past_treatments %}
  <ul class="list-group">
    {% for t in past_treatments %}
      <li class="list-group-item">
        <div><strong>{{ t.appt_date }} {{ t.appt_time }}</strong></div>
        <div><em>Diagnosis:</em> {{ t.diagnosis or '-' }}</div>
        <div><em>Prescription:</em> {{ t.prescription or '-' }}</div>
        <div><em>Notes:</em> {{ t.notes or '-' }}</div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <div class="text-muted">No prior treatments found for this patient.</div>
{% endif %}
{% endblock %}
